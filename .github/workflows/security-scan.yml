# Weekly security audit + PR dependency check
name: Security Scan

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 09:00 UTC
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'app/package.json'
      - 'app/package-lock.json'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Run npm audit
        id: npm_audit
        working-directory: app
        run: |
          AUDIT_OUTPUT=$(npm audit --json 2>/dev/null || true)
          VULN_COUNT=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.total // 0' 2>/dev/null || echo "0")

          echo "vuln_count=$VULN_COUNT" >> "$GITHUB_OUTPUT"
          {
            echo "audit_report<<AUDIT_EOF"
            npm audit 2>/dev/null || echo "No audit data available"
            echo "AUDIT_EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Found $VULN_COUNT vulnerabilities"

      - name: Create issue for vulnerabilities (scheduled run)
        if: github.event_name == 'schedule' && steps.npm_audit.outputs.vuln_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const auditReport = `${{ steps.npm_audit.outputs.audit_report }}`;
            const vulnCount = '${{ steps.npm_audit.outputs.vuln_count }}';

            // Check for existing open security issue to avoid duplicates
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security',
              per_page: 5
            });

            const existingIssue = issues.find(i => i.title.includes('vulnerabilities found'));
            if (existingIssue) {
              // Update existing issue instead of creating duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Scan (${new Date().toISOString().split('T')[0]})\n\n` +
                      `**Vulnerabilities found:** ${vulnCount}\n\n` +
                      `\`\`\`\n${auditReport.substring(0, 3000)}\n\`\`\``
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Security: ${vulnCount} vulnerabilities found in dependencies`,
                body: `## Weekly Security Scan Results\n\n` +
                      `**Vulnerabilities found:** ${vulnCount}\n\n` +
                      `### Audit Report\n\`\`\`\n${auditReport.substring(0, 3000)}\n\`\`\``,
                labels: ['security']
              });
            }

      - name: Comment on PR with vulnerabilities
        if: github.event_name == 'pull_request' && steps.npm_audit.outputs.vuln_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const vulnCount = '${{ steps.npm_audit.outputs.vuln_count }}';
            const auditReport = `${{ steps.npm_audit.outputs.audit_report }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Security Scan Warning\n\n` +
                    `**${vulnCount} vulnerabilities** found in dependencies changed by this PR.\n\n` +
                    `<details><summary>Audit Report</summary>\n\n` +
                    `\`\`\`\n${auditReport.substring(0, 3000)}\n\`\`\`\n</details>\n\n` +
                    `Please review and resolve before merging.`
            });

      - name: Report clean scan
        if: steps.npm_audit.outputs.vuln_count == '0'
        run: echo "No vulnerabilities found. Dependencies are clean."
