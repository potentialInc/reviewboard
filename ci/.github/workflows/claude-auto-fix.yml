name: Claude Auto-Fix on CI Failure

on:
  workflow_run:
    workflows: ["CI"]  # Adjust to your CI workflow name
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  auto-fix:
    # Only run on failure, only on agent/* branches
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      startsWith(github.event.workflow_run.head_branch, 'agent/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout failed branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "Claude Agent"
          git config user.email "claude-agent@users.noreply.github.com"

      - name: Get failure logs
        id: logs
        run: |
          # Download workflow logs
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failure-log.txt 2>/dev/null || echo "Could not fetch logs" > /tmp/failure-log.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Auto-Fix
        timeout-minutes: 15
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            CI failed on branch ${{ github.event.workflow_run.head_branch }}.
            Read CLAUDE.md and agents/bug-fixer.md for context.

            Failure logs:
            $(cat /tmp/failure-log.txt | tail -100)

            Fix the failing tests/build. Make minimal changes.
            Run ./architecture/enforce.sh to validate.
            Commit with message: "fix: resolve CI failure - <description>"
          direct_prompt: true

      - name: Push fixes
        run: |
          git push origin ${{ github.event.workflow_run.head_branch }}
